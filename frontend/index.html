

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>World Hover Map (Leaflet + TTS Panel)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; font-family: system-ui, sans-serif; }
    #container { display: flex; height: 100%; width: 100%; }
    #info-panel {
      width: 340px; background: #f9f9f9; border-right: 1px solid #ddd;
      padding: 16px; box-sizing: border-box; transition: transform .25s ease;
      transform: translateX(-100%); display: flex; flex-direction: column; gap: 12px;
    }
    #info-panel.open { transform: translateX(0); }
    #panel-header { display: flex; align-items: center; justify-content: space-between; }
    #country-name { margin: 0; font-size: 18px; }
    #close-btn { border: 0; background: #eee; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    #results { overflow: auto; flex: 1; }
    .muted { color: #666; font-size: 13px; }
    #map { flex: 1; }
    .country { fill: #e6e6e6; stroke: #999; stroke-width: 0.5; cursor: pointer; }
    .country-hover { fill: #cfd8ff !important; stroke: #4158d0 !important; stroke-width: 1 !important; }
    ul { padding-left: 18px; margin: 6px 0; }
    code { background: #eee; padding: 2px 4px; border-radius: 4px; }
  </style>
</head>
<body>
  <div id="container">
    <div id="info-panel">
      <div id="panel-header">
        <h3 id="country-name">Click a country</h3>
        <button id="close-btn" title="Close">✕</button>
      </div>
      <div id="query-line" class="muted"></div>
      <div id="results" class="muted">Country options will appear here.</div>
    </div>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  <script>
    const API_BASE = "/api/tts";
    const infoPanel = document.getElementById('info-panel');
    const nameEl = document.getElementById('country-name');
    const queryLine = document.getElementById('query-line');
    const resultsEl = document.getElementById('results');
    document.getElementById('close-btn').onclick = () => infoPanel.classList.remove('open');

    const map = L.map('map', { worldCopyJump: true }).setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap', maxZoom: 6 }).addTo(map);

    const WORLD_GEOJSON =
      'https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json';

    // --- NEW: client-side canonicalization (extra safety; server also normalizes)
    const COUNTRY_ALIASES = new Map([
      ['united states of america', 'United States'],
      ['usa', 'United States'],
      ['u.s.', 'United States'],
      ['us', 'United States'],
      // a few optional extras (edit/expand as needed):
      ['russian federation', 'Russia'],
      ['viet nam', 'Vietnam'],
      ['syrian arab republic', 'Syria'],
      ['democratic republic of the congo', 'DR Congo'],
      ['lao people\'s democratic republic', 'Laos'],
      ['iran (islamic republic of)', 'Iran'],
      ['bolivia (plurinational state of)', 'Bolivia'],
      ['venezuela (bolivarian republic of)', 'Venezuela'],
      ['republic of korea', 'South Korea'],
      ['korea, republic of', 'South Korea'],
    ]);
    function canonicalizeCountry(raw) {
      const key = (raw || '').trim().toLowerCase();
      return COUNTRY_ALIASES.get(key) || raw;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Render the /tts/by-language payload
    function renderByLanguage(payload) {
      // payload: { country, languages: [{language, providers: [...] }], count }
      const country = payload.country || '';
      nameEl.textContent = country || '—';
      queryLine.innerHTML = `Languages supported in <strong>${escapeHtml(country)}</strong>`;

      const arr = payload.languages || [];
      if (!arr.length) {
        resultsEl.innerHTML = `<span class="muted">No results.</span>`;
        return;
      }

      const items = arr.map(item => {
        const lang = escapeHtml(item.language || '');
        const provs = (item.providers || []).map(p => escapeHtml(p)).join(', ');
        return `<li><strong>${lang}</strong> — ${provs || '<span class="muted">No providers</span>'}</li>`;
      }).join('');
      resultsEl.innerHTML = `<ul>${items}</ul>`;
    }

    fetch(WORLD_GEOJSON)
      .then(r => r.json())
      .then(geojson => {
        const layer = L.geoJSON(geojson, {
          style: () => ({ className: 'country' }),
          onEachFeature: (feature, lyr) => {
            const raw = feature.properties.name || feature.properties.ADMIN || 'Unknown';
            const display = raw; // keep original label on map
            lyr.bindTooltip(display, { sticky: true, direction: 'center' });

            lyr.on('mouseover', () => lyr.getElement()?.classList.add('country-hover'));
            lyr.on('mouseout',  () => lyr.getElement()?.classList.remove('country-hover'));

            lyr.on('click', async () => {
              // use canonical when querying backend
              const canonical = canonicalizeCountry(raw);
              nameEl.textContent = display;
              infoPanel.classList.add('open');
              queryLine.textContent = 'Loading…';
              resultsEl.textContent = '';

              try {
                const url = `${API_BASE}/by-language?country=${encodeURIComponent(canonical)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`API ${res.status}`);
                const data = await res.json();
                renderByLanguage(data);
              } catch (e) {
                queryLine.textContent = '';
                resultsEl.innerHTML = `<span class="muted">Failed to fetch data: ${escapeHtml(String(e))}</span>`;
              }
            });
          }
        }).addTo(map);

        map.fitBounds(layer.getBounds());
      })
      .catch(err => {
        console.error('Failed to load GeoJSON', err);
        alert('Could not load world map data.');
      });
  </script>
</body>
</html>
